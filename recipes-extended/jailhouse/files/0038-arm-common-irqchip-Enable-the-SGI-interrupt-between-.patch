From 06e44a09a43763119c32f66a01689f968de627c9 Mon Sep 17 00:00:00 2001
From: Hou Zhiqiang <Zhiqiang.Hou@nxp.com>
Date: Fri, 30 Sep 2022 17:33:23 +0800
Subject: [PATCH 38/43] arm-common: irqchip: Enable the SGI interrupt between
 cells

Signed-off-by: Hou Zhiqiang <Zhiqiang.Hou@nxp.com>
---
 hypervisor/arch/arm-common/irqchip.c | 33 +++++++++++++++-------------
 1 file changed, 18 insertions(+), 15 deletions(-)

diff --git a/hypervisor/arch/arm-common/irqchip.c b/hypervisor/arch/arm-common/irqchip.c
index daae5512..cfc94668 100644
--- a/hypervisor/arch/arm-common/irqchip.c
+++ b/hypervisor/arch/arm-common/irqchip.c
@@ -110,27 +110,30 @@ void gic_handle_sgir_write(struct sgi *sgi)
 	struct public_per_cpu *cpu_public = this_cpu_public();
 	unsigned int cpu, target;
 	u64 cluster;
+	struct cell *cell;
 
 	if (sgi->routing_mode == 2)
 		/* Route to the caller itself */
 		irqchip_set_pending(cpu_public, sgi->id);
 	else
-		for_each_cpu(cpu, this_cell()->cpu_set) {
-			if (sgi->routing_mode == 1) {
-				/* Route to all (cell) CPUs but the caller. */
-				if (cpu == cpu_public->cpu_id)
-					continue;
-			} else {
-				target = irqchip_get_cpu_target(cpu);
-				cluster = irqchip_get_cluster_target(cpu);
-
-				/* Route to target CPUs in cell */
-				if ((sgi->cluster_id != cluster) ||
-				    !(sgi->targets & target))
-					continue;
+		for_each_cell(cell) {
+			for_each_cpu(cpu, cell->cpu_set) {
+				if (sgi->routing_mode == 1) {
+					/* Route to all (cell) CPUs but the caller. */
+					if (cpu == cpu_public->cpu_id)
+						continue;
+				} else {
+					target = irqchip_get_cpu_target(cpu);
+					cluster = irqchip_get_cluster_target(cpu);
+
+					/* Route to target CPUs in cell */
+					if ((sgi->cluster_id != cluster) ||
+					    !(sgi->targets & target))
+						continue;
+				}
+
+				irqchip_set_pending(public_per_cpu(cpu), sgi->id);
 			}
-
-			irqchip_set_pending(public_per_cpu(cpu), sgi->id);
 		}
 }
 
-- 
2.25.1

