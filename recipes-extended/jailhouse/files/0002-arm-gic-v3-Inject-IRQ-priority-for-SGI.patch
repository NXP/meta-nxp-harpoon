From 5c6093f6cbe7f6fea4a1cc4a8cf9f1b4d69097b3 Mon Sep 17 00:00:00 2001
From: Hou Zhiqiang <Zhiqiang.Hou@nxp.com>
Date: Thu, 12 Aug 2021 10:36:10 +0800
Subject: [PATCH 02/27] arm: gic-v3: Inject IRQ priority for SGI

Also inject the priority value for SGI to inmates.

Signed-off-by: Hou Zhiqiang <Zhiqiang.Hou@nxp.com>
---
 hypervisor/arch/arm-common/gic-v3.c | 18 +++++++++---------
 1 file changed, 9 insertions(+), 9 deletions(-)

diff --git a/hypervisor/arch/arm-common/gic-v3.c b/hypervisor/arch/arm-common/gic-v3.c
index c4bf80a4..c59aace3 100644
--- a/hypervisor/arch/arm-common/gic-v3.c
+++ b/hypervisor/arch/arm-common/gic-v3.c
@@ -622,17 +622,17 @@ static int gicv3_inject_irq(u16 irq_id, u16 sender)
 	if (!is_sgi(irq_id)) {
 		lr |= ICH_LR_HW_BIT;
 		lr |= (u64)irq_id << ICH_LR_PHYS_ID_SHIFT;
+	}
+
+	if (is_spi(irq_id))
+		iprio = mmio_read32(gicd_base + GICD_IPRIORITYR +
+				    (irq_id & ~3));
+	else
+		iprio = mmio_read32(gicr + GICR_IPRIORITYR + (irq_id & ~3));
 
-		if (is_spi(irq_id))
-			iprio = mmio_read32(gicd_base + GICD_IPRIORITYR +
-					    (irq_id & ~3));
-		else
-			iprio = mmio_read32(gicr + GICR_IPRIORITYR +
-					    (irq_id & ~3));
+	iprio = (iprio >> ((irq_id & 3) * 8)) & 0xff;
+	lr |= (u64)iprio << ICH_LR_PRIORITY_SHIFT;
 
-		iprio = (iprio >> ((irq_id & 3) * 8)) & 0xff;
-		lr |= (u64)iprio << ICH_LR_PRIORITY_SHIFT;
-	}
 	/* GICv3 doesn't support the injection of the calling CPU ID */
 
 	gicv3_write_lr(free_lr, lr);
-- 
2.34.1

