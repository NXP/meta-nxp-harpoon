From c30beb6cfa90d6b427761d0750b6eff4b6190bd8 Mon Sep 17 00:00:00 2001
From: Stephane Viau <stephane.viau@nxp.com>
Date: Fri, 18 Jun 2021 17:05:43 +0200
Subject: [PATCH 06/49] HRPN-29 imx8mp: zephyr: Use imx-cell helper functions

Signed-off-by: Stephane Viau <stephane.viau@nxp.com>
---
 configs/arm64/imx8mp-zephyr.c | 113 +++++++++-------------------------
 1 file changed, 28 insertions(+), 85 deletions(-)

diff --git a/configs/arm64/imx8mp-zephyr.c b/configs/arm64/imx8mp-zephyr.c
index 49ce9377..51eb667c 100644
--- a/configs/arm64/imx8mp-zephyr.c
+++ b/configs/arm64/imx8mp-zephyr.c
@@ -5,98 +5,41 @@
  *
  * Authors:
  *  Hou Zhiqiang <Zhiqiang.Hou@nxp.com>
+ *  Stephane Viau <stephane.viau@nxp.com>
  *
  * This work is licensed under the terms of the GNU GPL, version 2.  See
  * the COPYING file in the top-level directory.
  */
 
-#include <jailhouse/types.h>
-#include <jailhouse/cell-config.h>
+#include "cell-helper.h"
+#include "imx8mp-rtos.h"
 
-#define CONFIG_INMATE_BASE	0xc0000000
+/* Name, cores, entry point */
+#define CONFIG_INMATE_NAME		"zephyr-inmate-demo"
+#define CONFIG_INMATE_CORE_BITMAP	(0b1100)
+#define CONFIG_INMATE_BASE		(0xc0000000)
 
-struct {
-	struct jailhouse_cell_desc cell;
-	__u64 cpus[1];
-	struct jailhouse_memory mem_regions[7];
-	struct jailhouse_irqchip irqchips[1];
-} __attribute__((packed)) config = {
-	.cell = {
-		.signature = JAILHOUSE_CELL_DESC_SIGNATURE,
-		.revision = JAILHOUSE_CONFIG_REVISION,
-		.name = "zephyr-inmate-demo",
-		.flags = JAILHOUSE_CELL_PASSIVE_COMMREG,
+/* Memory & peripherals */
+#define CONFIG_INMATE_REGIONS_NUM	(RTOS_COMMON_MEMORY_REGIONS_NUM + 3)
+#define CONFIG_INMATE_REGIONS		\
+		RTOS_COMMON_MEMORY_REGIONS,                                     \
+		MMIO_REGION_RWS(0x30384000, 0x30384000, KB(4)), /* CCM clock gating */ \
+		MMIO_REGION_RWS(0x3038b000, 0x3038b000, KB(4)), /* CCM TARGET_ROOT */  \
+		MEM_REGION_RWXL(0xc0000000, 0xc0000000, MB(1)), /* RAM */              \
 
-		.cpu_set_size = sizeof(config.cpus),
-		.num_memory_regions = ARRAY_SIZE(config.mem_regions),
-		.num_irqchips = ARRAY_SIZE(config.irqchips),
-		.num_pci_devices = 0,
-		.cpu_reset_address = CONFIG_INMATE_BASE,
-	},
+/* GIC */
+#define CONFIG_INMATE_IRQCHIPS_NUM	(RTOS_COMMON_IRQCHIPS_NUM)
+#define CONFIG_INMATE_IRQCHIPS_ADDR	(0x38800000)
+#define CONFIG_INMATE_IRQCHIPS_BASE	(32)
+#define CONFIG_INMATE_IRQCHIPS_BITMAP	\
+				/* interrupts 32..63 */        \
+				RTOS_COMMON_IRQCHIPS_BITMAP1,  \
+				/* interrupts 64..95 */        \
+				RTOS_COMMON_IRQCHIPS_BITMAP2,  \
+				/* interrupts 96..127 */       \
+				RTOS_COMMON_IRQCHIPS_BITMAP3,  \
+				/* interrupts 128..159 */      \
+				RTOS_COMMON_IRQCHIPS_BITMAP4
 
-	.cpus = {
-		0xc,
-	},
+#include "cell-create.h"
 
-	.mem_regions = {
-		/* GPT1 */ {
-			.phys_start = 0x302d0000,
-			.virt_start = 0x302d0000,
-			.size = 0x10000,
-			.flags = JAILHOUSE_MEM_READ | JAILHOUSE_MEM_WRITE |
-				JAILHOUSE_MEM_IO,
-		},
-		/* GPT2 */ {
-			.phys_start = 0x302e0000,
-			.virt_start = 0x302e0000,
-			.size = 0x10000,
-			.flags = JAILHOUSE_MEM_READ | JAILHOUSE_MEM_WRITE |
-				JAILHOUSE_MEM_IO,
-		},
-		/* ANA_PLL */ {
-			.phys_start = 0x30360000,
-			.virt_start = 0x30360000,
-			.size = 0x10000,
-			.flags = JAILHOUSE_MEM_READ | JAILHOUSE_MEM_WRITE |
-				JAILHOUSE_MEM_IO | JAILHOUSE_MEM_ROOTSHARED,
-		},
-		/* CCM */ {
-			.phys_start = 0x30380000,
-			.virt_start = 0x30380000,
-			.size = 0x10000,
-			.flags = JAILHOUSE_MEM_READ | JAILHOUSE_MEM_WRITE |
-				JAILHOUSE_MEM_IO | JAILHOUSE_MEM_ROOTSHARED,
-		},
-		/* UART4 */ {
-			.phys_start = 0x30a60000,
-			.virt_start = 0x30a60000,
-			.size = 0x1000,
-			.flags = JAILHOUSE_MEM_READ | JAILHOUSE_MEM_WRITE |
-				JAILHOUSE_MEM_IO,
-		},
-		/* RAM: start from the bottom of inmate memory */ {
-			.phys_start = 0xc0000000,
-			.virt_start = 0xc0000000,
-			.size = 0x00100000,
-			.flags = JAILHOUSE_MEM_READ | JAILHOUSE_MEM_WRITE |
-				JAILHOUSE_MEM_EXECUTE | JAILHOUSE_MEM_LOADABLE,
-		},
-		/* communication region */ {
-			.virt_start = 0x80000000,
-			.size = 0x00001000,
-			.flags = JAILHOUSE_MEM_READ | JAILHOUSE_MEM_WRITE |
-				JAILHOUSE_MEM_COMM_REGION,
-		},
-	},
-
-	.irqchips = {
-		{
-			.address = 0x38800000,
-			.pin_base = 32,
-			.pin_bitmap = {
-				(1 << (29 + 32 - 32)), /* uart4 */
-				(1 << (54 + 32 - 64)) | (1 << (55 + 32 - 64)), /* GPT1, GPT2 */
-			},
-		},
-	},
-};
-- 
2.34.1

