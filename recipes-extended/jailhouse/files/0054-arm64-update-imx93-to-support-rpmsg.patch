From a201659f03f9cad72abc83e3801f930ce547616d Mon Sep 17 00:00:00 2001
From: Marouen Ghodhbane <marouen.ghodhbane@nxp.com>
Date: Fri, 19 May 2023 17:50:43 +0200
Subject: [PATCH 54/54] arm64: update imx93 to support rpmsg

Signed-off-by: Marouen Ghodhbane <marouen.ghodhbane@nxp.com>
---
 configs/arm64/imx93-harpoon-freertos.c | 11 ++++++++++-
 configs/arm64/imx93-harpoon-rtos.h     | 21 +++++++++++++++++----
 configs/arm64/imx93-harpoon-zephyr.c   | 11 ++++++++++-
 3 files changed, 37 insertions(+), 6 deletions(-)

diff --git a/configs/arm64/imx93-harpoon-freertos.c b/configs/arm64/imx93-harpoon-freertos.c
index e4ec750c..336ead5b 100644
--- a/configs/arm64/imx93-harpoon-freertos.c
+++ b/configs/arm64/imx93-harpoon-freertos.c
@@ -29,7 +29,16 @@
 		/* interrupts 96..127 */        \
 		RTOS_COMMON_IRQCHIP0_BITMAP3,   \
 		/* interrupts 128..159 */       \
-		RTOS_COMMON_IRQCHIP0_BITMAP4)
+		RTOS_COMMON_IRQCHIP0_BITMAP4),  \
+	IRQCHIP1(CONFIG_INMATE_IRQCHIPS_ADDR,   \
+		/* interrupts 160..191 */       \
+		RTOS_COMMON_IRQCHIP1_BITMAP1,   \
+		/* interrupts 192..223 */       \
+		RTOS_COMMON_IRQCHIP1_BITMAP2,   \
+		/* interrupts 224..255 */       \
+		RTOS_COMMON_IRQCHIP1_BITMAP3,   \
+		/* interrupts 256..287 */       \
+		RTOS_COMMON_IRQCHIP1_BITMAP4)
 
 /* IVSHMEM PCI */
 #define CONFIG_INMATE_PCI_DEVICES \
diff --git a/configs/arm64/imx93-harpoon-rtos.h b/configs/arm64/imx93-harpoon-rtos.h
index b45a6d55..e05c8e4e 100644
--- a/configs/arm64/imx93-harpoon-rtos.h
+++ b/configs/arm64/imx93-harpoon-rtos.h
@@ -15,6 +15,8 @@ typedef enum IRQn {
   LPUART2_IRQn                 = 52,               /**< Low Power UART 2 */
   TPM2_IRQn                    = 69,               /**< Timer PWM Module (TPM) 2 */
   TPM4_IRQn                    = 108,               /**< Timer PWM Module (TPM) 4 */
+  SW_MB_L_IRQn                 = 200,              /**< Unused SPI 168, to be used by generic software mailbox in Linux */
+  SW_MB_R_IRQn                 = 201,              /**< Unused SPI 169, to be used by generic software mailbox in RTOS */
 } IRQn_Type;
 
 #define RTOS_COMMON_MEMORY_REGIONS \
@@ -24,6 +26,9 @@ typedef enum IRQn {
 	MEM_REGION_RWS( 0xfd9fc000, 0xfd9fc000, KB(8)),  /* IVSHMEM */              \
 	MEM_REGION_ROS( 0xfd9fe000, 0xfd9fe000, KB(8)),  /* IVSHMEM */              \
 	/* IVSHMEM regions should always be kept on top so PCI_IVS doesn't change */\
+	MMIO_REGION_RWS(0xfe000000, 0xfe000000, KB(4)),  /* SW MBOX */              \
+	MMIO_REGION_RWS(0xfe100000, 0xfe100000, KB(64)), /* RPMSG */                \
+	MEM_REGION_RWS( 0xfe200000, 0xfe200000, MB(1)),  /* RPMSG BUF */            \
 	MMIO_REGION_RWS(0x443c0000, 0x443c0000, KB(64)), /* IOMUXC */               \
 	MMIO_REGION_RWS(0x44450000, 0x44450000, KB(64)), /* CCM */                  \
 	MMIO_REGION_ROS(0x44480000, 0x44480000, KB(64)), /* ANA_PLL */              \
@@ -41,7 +46,6 @@ typedef enum IRQn {
 /* interrupts 32..63 */
 #define RTOS_COMMON_IRQCHIP0_BITMAP1 \
 	IRQnMAP(LPUART2_IRQn)
-
 #define RTOS_AUDIO_IRQCHIP0_BITMAP1 \
 	0
 #define RTOS_AVB_IRQCHIP0_BITMAP1 \
@@ -52,7 +56,6 @@ typedef enum IRQn {
 /* interrupts 64..95 */
 #define RTOS_COMMON_IRQCHIP0_BITMAP2 \
 	IRQnMAP(TPM2_IRQn)
-
 #define RTOS_AUDIO_IRQCHIP0_BITMAP2 \
 	0
 #define RTOS_AVB_IRQCHIP0_BITMAP2 \
@@ -63,7 +66,6 @@ typedef enum IRQn {
 /* interrupts 96..127 */
 #define RTOS_COMMON_IRQCHIP0_BITMAP3 \
 	IRQnMAP(TPM4_IRQn)
-
 #define RTOS_AUDIO_IRQCHIP0_BITMAP3 \
 	0
 #define RTOS_AVB_IRQCHIP0_BITMAP3 \
@@ -74,7 +76,6 @@ typedef enum IRQn {
 /* interrupts 128..159 */
 #define RTOS_COMMON_IRQCHIP0_BITMAP4 \
 	0
-
 #define RTOS_AUDIO_IRQCHIP0_BITMAP4 \
 	0
 #define RTOS_AVB_IRQCHIP0_BITMAP4 \
@@ -83,6 +84,8 @@ typedef enum IRQn {
 	0
 
 /* interrupts 160..191 */
+#define RTOS_COMMON_IRQCHIP1_BITMAP1 \
+	0
 #define RTOS_AUDIO_IRQCHIP1_BITMAP1 \
 	0
 #define RTOS_AVB_IRQCHIP1_BITMAP1 \
@@ -92,6 +95,8 @@ typedef enum IRQn {
 	0
 
 /* interrupts 192..223 */
+#define RTOS_COMMON_IRQCHIP1_BITMAP2 \
+	IRQnMAP(SW_MB_R_IRQn)
 #define RTOS_AUDIO_IRQCHIP1_BITMAP2 \
 	0
 #define RTOS_AVB_IRQCHIP1_BITMAP2 \
@@ -100,6 +105,14 @@ typedef enum IRQn {
 #define RTOS_INDUS_IRQCHIP1_BITMAP2 \
 	0
 
+/* interrupts 224..255 */
+#define RTOS_COMMON_IRQCHIP1_BITMAP3 \
+	0
+
+/* interrupts 256..287 */
+#define RTOS_COMMON_IRQCHIP1_BITMAP4 \
+	0
+
 /* IVSHMEM PCI */
 #define	RTOS_COMMON_PCI_IVSHMEM \
 	PCI_IVSHMEM_UNDEFINED(0, 0, 0, 1, 3)
diff --git a/configs/arm64/imx93-harpoon-zephyr.c b/configs/arm64/imx93-harpoon-zephyr.c
index a30282e7..13007be2 100644
--- a/configs/arm64/imx93-harpoon-zephyr.c
+++ b/configs/arm64/imx93-harpoon-zephyr.c
@@ -29,7 +29,16 @@
 		/* interrupts 96..127 */        \
 		RTOS_COMMON_IRQCHIP0_BITMAP3,   \
 		/* interrupts 128..159 */       \
-		RTOS_COMMON_IRQCHIP0_BITMAP4)
+		RTOS_COMMON_IRQCHIP0_BITMAP4),  \
+	IRQCHIP1(CONFIG_INMATE_IRQCHIPS_ADDR,   \
+		/* interrupts 160..191 */       \
+		RTOS_COMMON_IRQCHIP1_BITMAP1,   \
+		/* interrupts 192..223 */       \
+		RTOS_COMMON_IRQCHIP1_BITMAP2,   \
+		/* interrupts 224..255 */       \
+		RTOS_COMMON_IRQCHIP1_BITMAP3,   \
+		/* interrupts 256..287 */       \
+		RTOS_COMMON_IRQCHIP1_BITMAP4)
 
 /* IVSHMEM PCI */
 #define CONFIG_INMATE_PCI_DEVICES \
-- 
2.34.1

